# ========================================
# AI E-Learning Platform - Complete CI/CD Pipeline
# ========================================
# Full pipeline ensuring smooth app operation and deployment

name: ðŸš€ CI/CD Pipeline

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  workflow_dispatch: # Manual trigger

env:
  NODE_VERSION: '18.x'
  PYTHON_VERSION: '3.9'

jobs:
  # =====================================
  # ðŸ“ DETECT CHANGES
  # =====================================
  detect-changes:
    name: ðŸ” Detect Changes
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
      any: ${{ steps.changes.outputs.frontend == 'true' || steps.changes.outputs.backend == 'true' }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - '.github/workflows/**'
            backend:
              - 'backend/**'
              - '.github/workflows/**'

  # =====================================
  # ðŸŽ¨ FRONTEND PIPELINE
  # =====================================
  frontend-pipeline:
    name: ðŸŽ¨ Frontend Pipeline
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.frontend == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      - name: ðŸ” ESLint Check
        run: npm run lint

      - name: ðŸ”§ TypeScript Check
        run: npx tsc --noEmit

      - name: ðŸ—ï¸ Production Build
        run: npm run build
        env:
          NODE_ENV: production
          SKIP_ENV_VALIDATION: true

      - name: ðŸ“Š Bundle Size Check
        run: |
          BUILD_SIZE=$(du -sh .next | cut -f1)
          echo "ðŸ—ï¸ Build size: $BUILD_SIZE" >> $GITHUB_STEP_SUMMARY
          
      - name: ðŸš€ Startup Test
        run: |
          timeout 30s npm start &
          PID=$!
          sleep 10
          if kill -0 $PID 2>/dev/null; then
            echo "âœ… Next.js starts successfully"
            kill $PID
          else
            echo "âŒ Next.js failed to start"
            exit 1
          fi

      - name: ðŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/.next/
          retention-days: 1

  # =====================================
  # ðŸ BACKEND PIPELINE
  # =====================================
  backend-pipeline:
    name: ðŸ Backend Pipeline
    needs: detect-changes
    if: ${{ needs.detect-changes.outputs.backend == 'true' }}
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: 'backend/requirements.txt'

      - name: ðŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: ðŸ” Ruff Linting
        run: ruff check .

      - name: ðŸŽ¨ Black Formatting
        run: black --check .

      - name: ðŸ§ª Import Tests
        run: python -c "from app.main import app; print('âœ… App imports successfully')"

      - name: ðŸ¥ Health Check Test
        run: |
          python -c "
          from app.main import app
          from fastapi.testclient import TestClient
          client = TestClient(app)
          response = client.get('/health')
          print(f'Health check status: {response.status_code}')
          assert response.status_code == 200, 'Health check failed'
          print('âœ… Health check passed')
          "

      - name: ðŸ› Pytest Basic Tests
        run: |
          if [ -d "tests" ]; then
            pytest tests/ -v --tb=short
          else
            echo "â„¹ï¸  No tests directory found, skipping pytest"
          fi

  # =====================================
  # ðŸ”— INTEGRATION TESTS
  # =====================================
  integration-tests:
    name: ðŸ”— Integration Tests
    needs: [frontend-pipeline, backend-pipeline]
    if: always() && (needs.frontend-pipeline.result == 'success' || needs.backend-pipeline.result == 'success')
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ Setup Python & Node
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: |
          cd backend && pip install -r requirements.txt
          cd ../frontend && npm ci

      - name: ðŸš€ Start Backend
        run: |
          cd backend
          python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 &
          echo $! > backend.pid
          sleep 5

      - name: ðŸ§ª API Integration Test
        run: |
          # Test basic API endpoints
          curl -f http://localhost:8000/health || exit 1
          curl -f http://localhost:8000/docs || exit 1
          echo "âœ… API integration tests passed"

      - name: ðŸ›‘ Cleanup
        if: always()
        run: |
          if [ -f backend.pid ]; then
            kill $(cat backend.pid) || true
          fi

  # =====================================
  # ðŸš€ DEPLOYMENT PIPELINE
  # =====================================
  deploy-staging:
    name: ðŸš€ Deploy to Staging
    needs: [frontend-pipeline, backend-pipeline, integration-tests]
    if: github.ref == 'refs/heads/master' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: staging

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ“¦ Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-build
          path: frontend/.next/

      - name: ðŸš€ Deploy to Staging
        run: |
          echo "ðŸš€ Deploying to staging environment..."
          echo "ðŸ“ Staging URL: https://staging.your-domain.com"
          # Add your deployment commands here
          # Examples:
          # - Deploy to Vercel staging
          # - Deploy to Railway staging
          # - Deploy to AWS staging

      - name: ðŸ¥ Post-Deploy Health Check
        run: |
          echo "ðŸ¥ Running post-deployment health checks..."
          # Add health check commands here
          # curl -f https://staging.your-domain.com/health

  deploy-production:
    name: ðŸ­ Deploy to Production
    needs: [deploy-staging]
    if: github.ref == 'refs/heads/master' && github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ­ Deploy to Production
        run: |
          echo "ðŸ­ Deploying to production environment..."
          echo "ðŸ“ Production URL: https://your-domain.com"
          # Add your production deployment commands here

      - name: ðŸ¥ Production Health Check
        run: |
          echo "ðŸ¥ Running production health checks..."
          # Add production health check commands here

  # =====================================
  # âœ… FINAL STATUS & NOTIFICATIONS
  # =====================================
  status-report:
    name: âœ… Pipeline Status
    needs: [frontend-pipeline, backend-pipeline, integration-tests, deploy-staging]
    if: always()
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“Š Generate Status Report
        run: |
          echo "## ðŸš€ CI/CD Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status | Details |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¨ Frontend | ${{ needs.frontend-pipeline.result || 'â­ï¸ Skipped' }} | Build, Lint, TypeScript |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ Backend | ${{ needs.backend-pipeline.result || 'â­ï¸ Skipped' }} | Lint, Format, Tests |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”— Integration | ${{ needs.integration-tests.result || 'â­ï¸ Skipped' }} | API & E2E Tests |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸš€ Staging | ${{ needs.deploy-staging.result || 'â­ï¸ Skipped' }} | Staging Deployment |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY